<!DOCTYPE html>
<html class="light" lang="es">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Plataforma de Citas M√©dicas - Mensajes</title>
<script src="https://cdn.tailwindcss.com?plugins=forms,container-queries"></script>
<link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&display=swap" rel="stylesheet"/>
<link href="https://fonts.googleapis.com/css2?family=Material+Symbols+Outlined" rel="stylesheet"/>
<script>
    tailwind.config = {
        darkMode: "class",
        theme: {
            extend: {
                colors: {
                    "primary": "#0E7C7B",
                    "accent": "#00B894",
                    "background-light": "#F4F8F8",
                    "background-dark": "#112121",
                    "container-light": "#FFFFFF",
                    "container-dark": "#1A2E2E",
                    "text-light": "#0e1b1b",
                    "text-dark": "#E0F2F2",
                    "subtext-light": "#4d9997",
                    "subtext-dark": "#A3D4D3",
                    "border-light": "#d0e7e7",
                    "border-dark": "#2A4545",
                },
                fontFamily: {
                    "display": ["Inter", "sans-serif"]
                },
                borderRadius: {
                    "DEFAULT": "0.5rem",
                    "lg": "0.75rem",
                    "xl": "1rem",
                    "full": "9999px"
                },
            },
        },
    }
</script>
<style>
    .material-symbols-outlined {
        font-variation-settings:
        'FILL' 0,
        'wght' 400,
        'GRAD' 0,
        'opsz' 24
    }
    #messages-container {
        scroll-behavior: smooth;
    }
</style>
</head>
<body class="bg-background-light dark:bg-background-dark font-display text-text-light dark:text-text-dark">
<div class="relative flex min-h-screen w-full flex-col">
<div class="flex h-full w-full flex-1">
<!-- SideNavBar -->
<aside class="flex h-full min-h-screen w-64 flex-col justify-between bg-container-light dark:bg-container-dark p-4 border-r border-border-light dark:border-border-dark sticky top-0">
<div class="flex flex-col gap-8">
<div class="flex items-center gap-3 px-2">
<div class="size-8 text-primary">
<svg fill="none" viewbox="0 0 48 48" xmlns="http://www.w3.org/2000/svg">
<path clip-rule="evenodd" d="M39.475 21.6262C40.358 21.4363 40.6863 21.5589 40.7581 21.5934C40.7876 21.655 40.8547 21.857 40.8082 22.3336C40.7408 23.0255 40.4502 24.0046 39.8572 25.2301C38.6799 27.6631 36.5085 30.6631 33.5858 33.5858C30.6631 36.5085 27.6632 38.6799 25.2301 39.8572C24.0046 40.4502 23.0255 40.7407 22.3336 40.8082C21.8571 40.8547 21.6551 40.7875 21.5934 40.7581C21.5589 40.6863 21.4363 40.358 21.6262 39.475C21.8562 38.4054 22.4689 36.9657 23.5038 35.2817C24.7575 33.2417 26.5497 30.9744 28.7621 28.762C30.9744 26.5497 33.2417 24.7574 35.2817 23.5037C36.9657 22.4689 38.4054 21.8562 39.475 21.6262ZM4.41189 29.2403L18.7597 43.5881C19.8813 44.7097 21.4027 44.9179 22.7217 44.7893C24.0585 44.659 25.5148 44.1631 26.9723 43.4579C29.9052 42.0387 33.2618 39.5667 36.4142 36.4142C39.5667 33.2618 42.0387 29.9052 43.4579 26.9723C44.1631 25.5148 44.659 24.0585 44.7893 22.7217C44.9179 21.4027 44.7097 19.8813 43.5881 18.7597L29.2403 4.41187C27.8527 3.02428 25.8765 3.02573 24.2861 3.36776C22.6081 3.72863 20.7334 4.58419 18.8396 5.74801C16.4978 7.18716 13.9881 9.18353 11.5858 11.5858C9.18354 13.988 7.18717 16.4978 5.74802 18.8396C4.58421 20.7334 3.72865 22.6081 3.36778 24.2861C3.02574 25.8765 3.02429 27.8527 4.41189 29.2403Z" fill="currentColor" fill-rule="evenodd"></path>
</svg>
</div>
<h2 class="text-text-light dark:text-text-dark text-lg font-bold leading-tight tracking-tight">Plataforma de Citas</h2>
</div>
<div class="flex flex-col gap-2">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20" href="administrator_dashboard.html">
<span class="material-symbols-outlined">dashboard</span>
<p class="text-sm font-medium leading-normal">Dashboard</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg bg-primary/20 text-primary" href="_chat.html">
<span class="material-symbols-outlined">chat</span>
<p class="text-sm font-bold leading-normal">Mensajes</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20" href="admin_manage_medical_facilities.html">
<span class="material-symbols-outlined">local_hospital</span>
<p class="text-sm font-medium leading-normal">Gesti√≥n de centros</p>
</a>
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20" href="#">
<span class="material-symbols-outlined">settings</span>
<p class="text-sm font-medium leading-normal">Configuraci√≥n</p>
</a>
</div>
</div>
<div class="flex flex-col gap-1">
<a class="flex items-center gap-3 px-3 py-2 rounded-lg hover:bg-primary/10 dark:hover:bg-primary/20 text-subtext-light dark:text-subtext-dark" href="#">
<span class="material-symbols-outlined text-sm">shield</span>
<p class="text-xs font-medium">Pol√≠tica de privacidad</p>
</a>
<div class="flex items-center gap-3 px-3 py-2 text-subtext-light dark:text-subtext-dark">
<span class="material-symbols-outlined text-sm">copyright</span>
<p class="text-xs font-medium">MIT ¬© 2025</p>
</div>
</div>
</aside>

<main class="flex-1 flex flex-col">
<!-- TopNavBar -->
<header class="flex items-center justify-between whitespace-nowrap border-b border-solid border-border-light dark:border-border-dark px-8 py-4 sticky top-0 bg-background-light/80 dark:bg-background-dark/80 backdrop-blur-sm z-10">
<h1 class="text-xl font-bold text-text-light dark:text-text-dark">Mensajes</h1>
<div class="flex items-center gap-4">
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 w-10 bg-container-light dark:bg-container-dark text-text-light dark:text-text-dark border border-border-light dark:border-border-dark hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">notifications</span>
</button>
<button class="flex max-w-[480px] cursor-pointer items-center justify-center overflow-hidden rounded-full h-10 w-10 bg-container-light dark:bg-container-dark text-text-light dark:text-text-dark border border-border-light dark:border-border-dark hover:bg-primary/10 dark:hover:bg-primary/20">
<span class="material-symbols-outlined">logout</span>
</button>
<div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style='background-image: url("https://lh3.googleusercontent.com/aida-public/AB6AXuAOpelaqTNL5J-Pjovj0KMv4Rx2fSFkoVQZrRgg5Gt55U4hzzsIaEyzRJhVLkn_k_ZtWQojvUqpcKGsjdYHVpLwywRjCXWElDE19nzXIWUkpxxaVfvjCYs0-clqHn_4z-y-5m4MpWYuc0nhY0IMs-uy5VhE3EqE2mx-mJbF_Y1W9Si3RpU2kfVhGcwPj6m-HfL7o11bzclr3WJmkeqB8u4fhbSeYYCsvA8v0IPJhHsnBLGYZUZp5bjPDYfSixxHF2S7DSySpbT0TXI");'></div>
</div>
</header>

<div class="flex flex-1 overflow-hidden">
<!-- Chat List Sidebar -->
<aside class="w-80 border-r border-border-light dark:border-border-dark bg-container-light dark:bg-container-dark overflow-hidden flex flex-col">
<div class="p-4 border-b border-border-light dark:border-border-dark">
<div class="relative">
<span class="material-symbols-outlined absolute left-3 top-1/2 -translate-y-1/2 text-subtext-light dark:text-subtext-dark">search</span>
<input id="search-chat" class="form-input w-full rounded-lg border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary focus:border-primary pl-10 pr-4 py-2" placeholder="Buscar conversaci√≥n..." type="text"/>
</div>
</div>

<nav id="chat-list" class="flex-1 overflow-y-auto p-2 space-y-1">
<!-- Chats se cargar√°n aqu√≠ din√°micamente -->
</nav>
</aside>

<!-- Chat Area -->
<div class="flex-1 flex flex-col bg-background-light dark:bg-background-dark">
<!-- Chat Header -->
<div id="chat-header" class="flex items-center justify-between p-4 border-b border-border-light dark:border-border-dark bg-container-light dark:bg-container-dark">
<div class="flex items-center gap-4">
<div class="relative">
<div id="active-chat-avatar" class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-12"></div>
<span id="online-indicator" class="hidden absolute bottom-0 right-0 block h-3 w-3 rounded-full bg-accent ring-2 ring-white dark:ring-container-dark"></span>
</div>
<div>
<p id="active-chat-name" class="text-lg font-bold text-text-light dark:text-text-dark">Selecciona una conversaci√≥n</p>
<p id="active-chat-status" class="text-sm text-subtext-light dark:text-subtext-dark"></p>
</div>
</div>
</div>

<!-- Messages Container -->
<div id="messages-container" class="flex-1 overflow-y-auto p-6 space-y-4">
<div class="flex flex-col items-center justify-center h-full text-center">
<span class="material-symbols-outlined text-7xl text-subtext-light/30 dark:text-subtext-dark/30">chat_bubble_outline</span>
<h3 class="mt-4 text-xl font-semibold text-text-light dark:text-text-dark">Selecciona un chat para comenzar</h3>
<p class="mt-2 text-sm text-subtext-light dark:text-subtext-dark">Elige una conversaci√≥n del panel izquierdo</p>
</div>
</div>

<!-- Message Input -->
<div id="message-input-area" class="hidden p-4 border-t border-border-light dark:border-border-dark bg-container-light dark:bg-container-dark">
<div class="flex items-center gap-3">
<button class="p-2 rounded-full hover:bg-background-light dark:hover:bg-background-dark transition-colors">
<span class="material-symbols-outlined text-subtext-light dark:text-subtext-dark">attach_file</span>
</button>
<input id="message-input" class="form-input flex-1 rounded-full border border-border-light dark:border-border-dark bg-background-light dark:bg-background-dark text-text-light dark:text-text-dark focus:ring-2 focus:ring-primary focus:border-primary px-4 py-2" placeholder="Escribe un mensaje..." type="text"/>
<button id="send-button" class="flex items-center justify-center size-10 rounded-full bg-primary text-white hover:bg-primary/90 transition-colors">
<span class="material-symbols-outlined">send</span>
</button>
</div>
</div>
</div>
</div>
</main>
</div>
</div>

<script>
// Datos de ejemplo de chats
const chats = [
    {
        id: 1,
        name: "Dra. Elena Torres",
        avatar: "https://i.pravatar.cc/150?img=1",
        lastMessage: "Hola, ¬øen qu√© puedo ayudarte?",
        time: "10:42 AM",
        unread: 0,
        online: true
    },
    {
        id: 2,
        name: "Dr. Garc√≠a Mart√≠nez",
        avatar: "https://i.pravatar.cc/150?img=12",
        lastMessage: "Perfecto, nos vemos entonces.",
        time: "Ayer",
        unread: 2,
        online: false
    },
    {
        id: 3,
        name: "Cl√≠nica Central",
        avatar: "https://i.pravatar.cc/150?img=30",
        lastMessage: "Su cita ha sido confirmada.",
        time: "2d",
        unread: 0,
        online: false
    }
];

let messages = {
    1: [
        { sender: "other", text: "Hola, ¬øen qu√© puedo ayudarte?", time: "10:42 AM" },
        { sender: "me", text: "¬°Hola, Dra. Torres! Quer√≠a consultar sobre los resultados de mis √∫ltimos an√°lisis.", time: "10:45 AM" },
        { sender: "other", text: "Claro, los estoy revisando ahora mismo. Un momento, por favor.", time: "10:46 AM" }
    ],
    2: [],
    3: []
};

let activeChat = null;
const userAvatar = "https://i.pravatar.cc/150?img=68";

// Renderizar lista de chats
function renderChatList() {
    const chatList = document.getElementById('chat-list');
    chatList.innerHTML = chats.map(chat => `
        <a href="#" onclick="openChat(${chat.id}); return false;" class="flex items-center gap-3 px-3 py-3 rounded-lg hover:bg-background-light dark:hover:bg-background-dark transition-colors ${activeChat === chat.id ? 'bg-primary/20 dark:bg-primary/30' : ''}">
            <div class="relative shrink-0">
                <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full size-10" style="background-image: url('${chat.avatar}');"></div>
                ${chat.online ? '<span class="absolute bottom-0 right-0 block h-2.5 w-2.5 rounded-full bg-accent ring-2 ring-white dark:ring-container-dark"></span>' : ''}
            </div>
            <div class="flex-1 truncate">
                <div class="flex justify-between items-center">
                    <p class="text-sm font-semibold text-text-light dark:text-text-dark">${escapeHtml(chat.name)}</p>
                    <p class="text-xs text-subtext-light dark:text-subtext-dark">${chat.time}</p>
                </div>
                <div class="flex justify-between items-center mt-1">
                    <p class="text-xs text-subtext-light dark:text-subtext-dark truncate">${escapeHtml(chat.lastMessage)}</p>
                    ${chat.unread > 0 ? `<span class="flex items-center justify-center h-5 w-5 rounded-full bg-accent text-white text-xs font-bold">${chat.unread}</span>` : ''}
                </div>
            </div>
        </a>
    `).join('');
}

// Abrir chat
function openChat(chatId) {
    activeChat = chatId;
    const chat = chats.find(c => c.id === chatId);
    
    // Actualizar header
    document.getElementById('active-chat-avatar').style.backgroundImage = `url('${chat.avatar}')`;
    document.getElementById('active-chat-name').textContent = chat.name;
    document.getElementById('active-chat-status').textContent = chat.online ? 'En l√≠nea' : 'Desconectado';
    document.getElementById('online-indicator').classList.toggle('hidden', !chat.online);
    
    // Mostrar √°rea de input
    document.getElementById('message-input-area').classList.remove('hidden');
    
    // Renderizar mensajes
    renderMessages(chatId);
    
    // Actualizar lista de chats
    renderChatList();
}

// Renderizar mensajes
function renderMessages(chatId) {
    const container = document.getElementById('messages-container');
    const chatMessages = messages[chatId] || [];
    
    if (chatMessages.length === 0) {
        container.innerHTML = `
            <div class="flex flex-col items-center justify-center h-full text-center">
                <span class="material-symbols-outlined text-7xl text-subtext-light/30 dark:text-subtext-dark/30">chat</span>
                <h3 class="mt-4 text-xl font-semibold text-text-light dark:text-text-dark">No hay mensajes a√∫n</h3>
                <p class="mt-2 text-sm text-subtext-light dark:text-subtext-dark">S√© el primero en enviar un mensaje</p>
            </div>
        `;
        return;
    }
    
    container.innerHTML = chatMessages.map(msg => {
        if (msg.sender === 'other') {
            const chat = chats.find(c => c.id === chatId);
            return `
                <div class="flex items-end gap-3">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0" style="background-image: url('${chat.avatar}');"></div>
                    <div class="flex flex-col gap-1 items-start max-w-md">
                        <p class="text-base font-normal leading-normal rounded-xl rounded-bl-sm px-4 py-3 bg-container-light dark:bg-container-dark text-text-light dark:text-text-dark border border-border-light dark:border-border-dark">${escapeHtml(msg.text)}</p>
                        <p class="text-xs text-subtext-light dark:text-subtext-dark pl-1">${msg.time}</p>
                    </div>
                </div>
            `;
        } else {
            return `
                <div class="flex flex-row-reverse items-end gap-3">
                    <div class="bg-center bg-no-repeat aspect-square bg-cover rounded-full w-10 shrink-0" style="background-image: url('${userAvatar}');"></div>
                    <div class="flex flex-col gap-1 items-end max-w-md">
                        <p class="text-base font-normal leading-normal rounded-xl rounded-br-sm px-4 py-3 bg-primary text-white">${escapeHtml(msg.text)}</p>
                        <div class="flex items-center gap-1 pr-1">
                            <p class="text-xs text-subtext-light dark:text-subtext-dark">${msg.time}</p>
                            <span class="material-symbols-outlined text-sm text-accent">done_all</span>
                        </div>
                    </div>
                </div>
            `;
        }
    }).join('');
    
    // Scroll to bottom
    container.scrollTop = container.scrollHeight;
}

// Enviar mensaje
function sendMessage() {
    if (!activeChat) return;
    
    const input = document.getElementById('message-input');
    const text = input.value.trim();
    
    if (!text) return;
    
    const time = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
    
    if (!messages[activeChat]) {
        messages[activeChat] = [];
    }
    
    messages[activeChat].push({
        sender: "me",
        text: text,
        time: time
    });
    
    input.value = '';
    renderMessages(activeChat);
    
    // Actualizar √∫ltimo mensaje en la lista
    const chat = chats.find(c => c.id === activeChat);
    if (chat) {
        chat.lastMessage = text.substring(0, 30) + (text.length > 30 ? '...' : '');
        chat.time = time;
        renderChatList();
    }
    
    // Simular respuesta autom√°tica despu√©s de 2 segundos
    setTimeout(() => {
        const responses = [
            "Entiendo, d√©jame verificar eso.",
            "Gracias por tu mensaje.",
            "Perfecto, te mantengo informado.",
            "¬øHay algo m√°s en lo que pueda ayudarte?"
        ];
        const randomResponse = responses[Math.floor(Math.random() * responses.length)];
        
        messages[activeChat].push({
            sender: "other",
            text: randomResponse,
            time: new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' })
        });
        
        if (activeChat === activeChat) {
            renderMessages(activeChat);
        }
    }, 2000);
}

// Event listeners
document.getElementById('send-button').addEventListener('click', sendMessage);
document.getElementById('message-input').addEventListener('keypress', (e) => {
    if (e.key === 'Enter') {
        sendMessage();
    }
});

// B√∫squeda de chats
document.getElementById('search-chat').addEventListener('input', (e) => {
    const searchTerm = e.target.value.toLowerCase();
    const chatItems = document.querySelectorAll('#chat-list a');
    
    chatItems.forEach(item => {
        const name = item.querySelector('.text-sm.font-semibold').textContent.toLowerCase();
        if (name.includes(searchTerm)) {
            item.style.display = 'flex';
        } else {
            item.style.display = 'none';
        }
    });
});

// Inicializar
renderChatList();
    </script>

    <!-- üîí PROTECCI√ìN JWT -->
    <script src="js/api.js"></script>
    <script>
        // CR√çTICO: Proteger acceso - Usuarios autenticados (cualquier rol)
        protectPage(); // Sin rol espec√≠fico = cualquier usuario autenticado
    </script>
</body>
</html>